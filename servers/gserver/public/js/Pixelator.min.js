var Pixelator=function(opts){this.opts=$.extend({width:400,height:400,mode:"edit",includeToolbar:!1,element:"",pixelSize:13,rawData:{},currentColor:"#000",eventMode:"fillPixel",cursor:"pointer",gridBGCellColor:"#e1e1e1",strokeWidth:1,onMouseDown:function(mode,pixel,pxltr){},onMouseMove:function(mode,pixel,pxltr){},onMouseUp:function(mode,pixel,pxltr){}},opts),this.el=$(this.opts.element)[0],this.ctx=this.el.getContext("2d"),this.wpr=!1,this.isMouseDown=!1,this.rawData={},this.history=[{}],this.redoHistory=[],this.downloadURL=this.el.toDataURL(),this.init=function(){if(this.ctx.imageSmoothingEnabled=!1,this.ctx.mozImageSmoothingEnabled=!1,this.ctx.oImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.el.width=this.opts.width,this.el.height=this.opts.height,$(this.opts.element).css({width:this.opts.width,height:this.opts.height,cursor:this.opts.cursor}),this.ctx.lineWidth=this.opts.strokeWidth,"edit"==this.opts.mode){var that=this;this.el.onmousedown=function(e){$(".debugConsole").html("event: "+JSON.stringify({clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY})),that.mouseDown(e)},this.el.onmouseout=function(e){that.mouseUp(e)},this.el.onmouseup=function(e){that.mouseUp(e)},this.el.onmousemove=function(e){that.mouseMove(e)},this.el.addEventListener("touchmove",function(e){$(".debugConsole").html("event: "+JSON.stringify({clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY})),that.replicateMouseEvent(e,"mousedown")}),this.el.addEventListener("touchmove",function(e){that.replicateMouseEvent(e,"mousemove")}),this.el.addEventListener("touchleave",function(e){that.replicateMouseEvent(e,"mouseup")}),this.el.addEventListener("touchend",function(e){$(".debugConsole").html("event: touchend"),that.replicateMouseEvent(e,"mouseup")}),this.el.addEventListener("touchcancel",function(e){that.replicateMouseEvent(e,"mouseup")}),document.body.addEventListener("touchstart",function(e){e.target==that.el&&e.preventDefault()},!1),document.body.addEventListener("touchend",function(e){e.target==that.el&&e.preventDefault()},!1),document.body.addEventListener("touchmove",function(e){e.target==that.el&&e.preventDefault()},!1),this.layoutGrid(),$(this.el).wrap("<div class='pxltr_wpr'></div>"),this.wpr=$(this.el).closest(".pxltr_wpr")[0],$(this.wpr).width(this.opts.width),!0===this.opts.includeToolbar&&this.setupToolbar()}},this.replicateMouseEvent=function(e,eventName){console.log("eventName:",eventName,e);var touch=e.touches[0],mouseEvent=new MouseEvent(eventName,{clientX:"mouseup"==eventName?0:touch.pageX,clientY:"mouseup"==eventName?0:touch.pageY});this.el.dispatchEvent(mouseEvent)},this.setupToolbar=function(){var that=this,$toolbar=$("<div class='toolbar'><div class='toolbar_wpr'>Color: <input id='pixelColor' type='color' /><div class='toggler' data-toggler-event='changeMode'><div class='pxltr_btn active' data-value='fillPixel'>Draw</div><div class='pxltr_btn'  data-value='paintBucket'>Fill</div><div class='pxltr_btn'  data-value='eraser'>Eraser</div></div><a href='#' download='pixltr_image.png' class='saveBtn pxltr_btn rightAlign'>Save</a><div class= 'clearBtn pxltr_btn rightAlign'>Clear</div><div class= 'undoBtn pxltr_btn rightAlign disabled'>Undo</div><div class= 'redoBtn pxltr_btn rightAlign disabled'>Redo</div><div style='clear:both;'></div></div></div>");$toolbar.width(that.opts.width);var $wpr=$(this.wpr);$wpr.append($toolbar),$("#pixelColor").spectrum({showPaletteOnly:!0,change:function(color){console.log("color change!"),that.opts.currentColor=color.toHexString()},togglePaletteOnly:!0,togglePaletteMoreText:"more",togglePaletteLessText:"less",color:that.opts.currentColor,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]}),$wpr.find(".toggler .pxltr_btn").each(function(){$(this).on("click",function(){$(this).parent().find(".pxltr_btn").removeClass("active"),$(that.el).trigger($(this).parent().attr("data-toggler-event"),[{value:$(this).attr("data-value")}]),$(this).addClass("active")})}),$(that.el).on("canvasChange",function(e,data){$wpr.find(".saveBtn").attr("href",that.downloadURL)}),$(that.el).on("changeMode",function(e,data){that.opts.eventMode=data.value}),$(that.el).on("historyChange",function(e,data){that.history.length<=0?$wpr.find(".undoBtn").addClass("disabled"):$wpr.find(".undoBtn").removeClass("disabled"),that.redoHistory.length<=0?$wpr.find(".redoBtn").addClass("disabled"):$wpr.find(".redoBtn").removeClass("disabled")}),$wpr.find(".undoBtn").on("click",function(e){that.undo()}),$wpr.find(".redoBtn").on("click",function(e){that.redo()}),$wpr.find(".clearBtn").on("click",function(e){that.clearBoard()})},this.import=function(rawData,inputPixelModule){var coords,that=this,newData={};$.each(rawData,function(k,v){coords=k.split(",").map(function(v2){return Number(v2)/inputPixelModule*that.opts.pixelSize}),newData[coords.join(",")]=v}),this.rawData=newData,this.redrawFromRaw()},this.mouseDown=function(e){"fillPixel"==this.opts.eventMode?this.fillPixel([e.offsetX,e.offsetY]):"paintBucket"==this.opts.eventMode?this.paintBucket([e.offsetX,e.offsetY]):"eraser"==this.opts.eventMode&&this.eraser([e.offsetX,e.offsetY]),this.opts.onMouseDown(this.opts.eventMode,[e.offsetX,e.offsetY],this),this.isMouseDown=!0},this.mouseMove=function(e){"fillPixel"==this.opts.eventMode?this.isMouseDown&&this.fillPixel([e.offsetX,e.offsetY]):"eraser"==this.opts.eventMode&&this.isMouseDown&&this.eraser([e.offsetX,e.offsetY]),this.isMouseDown&&this.opts.onMouseMove(this.opts.eventMode,[e.offsetX,e.offsetY],this)},this.change=function(){this.export(),$(this.el).trigger("canvasChange")},this.clearBoard=function(preserveData){preserveData||(this.rawData={}),this.ctx.clearRect(0,0,this.el.width,this.el.height),"edit"==this.opts.mode&&this.layoutGrid()},this.isBlankCanvas=function(){return $.isEmptyObject(this.rawData)},this.mouseUp=function(e){this.isMouseDown&&($(".debugConsole").html("change found!"),this.opts.onMouseUp(this.opts.eventMode,[e.offsetX,e.offsetY],this),this.redoHistory=[],this.change(),this.saveHistoryState()),this.isMouseDown=!1},this.saveHistoryState=function(){this.history.push($.extend({},this.rawData)),$(this.el).trigger("historyChange")},this.undo=function(){var lastThing=this.history.pop();this.redoHistory.push(lastThing),this.rawData=$.extend({},this.history[this.history.length-1]),$(this.el).trigger("historyChange"),this.redrawFromRaw()},this.redo=function(){var lastThing=this.redoHistory.pop();this.rawData=$.extend({},lastThing),$(this.el).trigger("historyChange"),this.redrawFromRaw(),this.history.push(lastThing)},this.nearest=function(x,n){return Math.floor(x/n)*n},this.getNearestNode=function(xy){return[this.nearest(xy[0],this.opts.pixelSize),this.nearest(xy[1],this.opts.pixelSize)]},this.colorAtNode=function(xy){return nearestNode=this.getNearestNode(xy),this.rawData[nearestNode.join(",")]},this.paintBucket=function(xy,color){var that=this;if(nearestNode=this.getNearestNode(xy),0<=nearestNode[0]&&nearestNode[0]<this.opts.width&&0<=nearestNode[1]&&nearestNode[1]<this.opts.height){colorAtNode=this.colorAtNode(nearestNode),this.fillPixel(nearestNode,color);var allPieces=[[nearestNode[0],nearestNode[1]+this.opts.pixelSize],[nearestNode[0],nearestNode[1]-this.opts.pixelSize],[nearestNode[0]-this.opts.pixelSize,nearestNode[1]],[nearestNode[0]+this.opts.pixelSize,nearestNode[1]]];$.each(allPieces,function(k,v){that.rawData[v.join(",")]!=colorAtNode||that.paintBucket(v)})}},this.eraser=function(xy,color){nearestNode=this.getNearestNode(xy),delete this.rawData[nearestNode.join(",")],this.redrawFromRaw()},this.redrawFromRaw=function(){this.clearBoard(!0),this.drawRawData(this.rawData)},this.fillPixel=function(xy,color,ignoreFromLog){ignoreFromLog=ignoreFromLog||!1,nearestNode=this.getNearestNode(xy),0==ignoreFromLog&&(this.rawData[nearestNode.join(",")]=color||this.opts.currentColor),this.rect(nearestNode,this.opts.pixelSize,this.opts.pixelSize,color)},this.rect=function(startPt,width,height,color){if(this.ctx.beginPath(),this.ctx.rect(startPt[0],startPt[1],this.opts.pixelSize,this.opts.pixelSize),this.ctx.closePath(),null!=color){var origColor=this.ctx.fillStyle;this.ctx.fillStyle=color,this.ctx.fill(),this.ctx.fillStyle=origColor}else this.ctx.fillStyle=this.opts.currentColor,this.ctx.fill()},this.export=function(){$("#pxltr_tmp").remove(),$("<canvas id='pxltr_tmp' style:'display:none'></canvas>").appendTo("body");var pxltr_tmp=new Pixelator($.extend({},this.opts,{element:"#pxltr_tmp",mode:"display"}));pxltr_tmp.drawRawData(this.rawData),this.downloadURL=pxltr_tmp.el.toDataURL(),$("#pxltr_tmp").remove(),delete pxltr_tmp},this.getImgUrl=function(){return this.export(),this.downloadURL},this.drawRawData=function(rawData){var that=this;$.each(rawData,function(k,v){coords=k.split(",").map(function(n){return Number(n)}),that.fillPixel(coords,v)})},this.drawLine=function(from,to,color){this.ctx.beginPath(),this.ctx.moveTo(from[0],from[1]),this.ctx.lineTo(to[0],to[1]),this.ctx.closePath();var origColor=this.ctx.strokeStyle;null!=color?(this.ctx.strokeStyle=color,this.ctx.stroke(),this.ctx.strokeStyle=origColor):this.ctx.stroke()},this.layoutGrid=function(){for(var rowCount=0,colCount=0,i=this.opts.width;0<=i;i-=this.opts.pixelSize){colCount=0;for(var j=this.opts.height;0<=j;j-=this.opts.pixelSize)rowCount%2!=colCount%2&&this.fillPixel([i,j],this.opts.gridBGCellColor,!0),colCount++;rowCount++}},this.init()};